#!/bin/bash

# claude-run: Unified entry point for provider switching and executable markdown
#
# Interactive mode:
#   claude-run                     # Same as claude
#   claude-run --aws --opus        # Same as claude-aws --opus
#
# Shebang mode:
#   claude-run prompt.md           # Execute markdown file
#   #!/usr/bin/env claude-run      # In markdown file

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
source "$SCRIPT_DIR/claude-switcher-utils.sh"

# Capture stdin early if being piped to (not a TTY)
# Must happen before argument parsing
STDIN_CONTENT=""
if [[ ! -t 0 ]]; then
    STDIN_CONTENT=$(cat)
fi

# Parse arguments
PROVIDER=""
PROVIDER_ARGS=()  # Model flags for provider
CLAUDE_ARGS=()    # Pass-through to claude
MD_FILE=""
NEEDS_VERBOSE=false  # Track if --output-format stream-json is used
STDIN_POSITION="prepend"  # Default: stdin content comes before file content

while [[ $# -gt 0 ]]; do
    case $1 in
        # Handle --output-format which requires --verbose for stream-json
        --output-format)
            CLAUDE_ARGS+=("$1" "$2")
            if [[ "$2" == "stream-json" ]]; then
                NEEDS_VERBOSE=true
            fi
            shift 2 ;;
        --output-format=*)
            CLAUDE_ARGS+=("$1")
            if [[ "$1" == "--output-format=stream-json" ]]; then
                NEEDS_VERBOSE=true
            fi
            shift ;;
        # Provider selection
        --aws)     PROVIDER="aws"; shift ;;
        --vertex)  PROVIDER="vertex"; shift ;;
        --apikey)  PROVIDER="apikey"; shift ;;
        --azure)   PROVIDER="azure"; shift ;;
        --vercel)  PROVIDER="vercel"; shift ;;
        --pro)     PROVIDER="pro"; shift ;;
        
        # Model flags (pass to provider script)
        --opus|--sonnet|--haiku)
            PROVIDER_ARGS+=("$1"); shift ;;
        --model)
            PROVIDER_ARGS+=("$1" "$2"); shift 2 ;;
        
        # Detect markdown file (positional argument ending in .md)
        *.md)
            if [[ -f "$1" ]]; then
                MD_FILE="$1"
            else
                print_error "File not found: $1"
                exit 1
            fi
            shift ;;
        
        # Stdin position for piped input
        --stdin-position)
            STDIN_POSITION="$2"
            if [[ "$STDIN_POSITION" != "prepend" && "$STDIN_POSITION" != "append" ]]; then
                print_error "Invalid --stdin-position: $2 (must be 'prepend' or 'append')"
                exit 1
            fi
            shift 2 ;;
        
        # Version flag
        --version|-v)
            echo "claude-switcher v$SWITCHER_VERSION"
            exit 0
            ;;
        
        # Help flag
        --help|-h)
            cat << 'EOF'
Usage: claude-run [OPTIONS] [file.md]

A unified entry point for Claude Code provider switching and executable markdown.

INTERACTIVE MODE (no .md file):
  claude-run                    Same as: claude
  claude-run --aws              Same as: claude-aws
  claude-run --aws --opus       Same as: claude-aws --opus
  claude-run --vertex --resume  Same as: claude-vertex --resume

SHEBANG MODE (.md file provided):
  claude-run prompt.md          Execute markdown as prompt
  ./prompt.md                   With #!/usr/bin/env claude-run shebang

PIPED SCRIPT MODE (stdin without file):
  curl -fsSL URL/install.md | claude-run    Execute remote markdown script
  echo "Prompt" | claude-run                Execute piped content as prompt
  
  Shebang flags in piped content are honored (e.g., --permission-mode).
  CLI flags override shebang flags.

PROVIDER FLAGS:
  --aws       Use AWS Bedrock
  --vertex    Use Google Vertex AI
  --apikey    Use Anthropic API
  --azure     Use Microsoft Azure
  --vercel    Use Vercel AI Gateway
  --pro       Use Claude Pro/Max subscription

MODEL FLAGS:
  --opus      Use Opus 4.5
  --sonnet    Use Sonnet 4.5 (default)
  --haiku    Use Haiku 4.5
  --model ID  Use specific model ID

SHEBANG/PIPED MODE FLAGS (pass to claude -p):
  --output-format <fmt>   Output format: text, json, stream-json
  --max-budget-usd <amt>  Maximum API spend
  --json-schema <schema>  Enforce JSON structure
  --permission-mode <m>   Permission mode (e.g., bypassPermissions)
  --stdin-position <pos>  Where to place piped input: 'prepend' (default) or 'append'
  All other claude flags are passed through.

STDIN PIPING:
  Pipe data into scripts for Unix-style workflows:
    echo '{"key": "value"}' | ./analyze.md      # Stdin prepended to prompt
    cat data.txt | ./summarize.md --stdin-position append

SECURITY WARNING:
  Piped and shebang modes run AI-generated code without interactive approval.
  Review scripts before running. Never use --dangerously-skip-permissions
  outside sandboxed environments.
EOF
            exit 0
            ;;
        
        # Everything else passes through to claude
        *)
            CLAUDE_ARGS+=("$1"); shift ;;
    esac
done

#=============================================================================
# MODE 1: SHEBANG/FILE EXECUTION (non-interactive)
#=============================================================================
if [[ -n "$MD_FILE" ]]; then
    # Read file content, strip shebang if present
    if [[ "$(head -1 "$MD_FILE")" == "#!"* ]]; then
        CONTENT=$(tail -n +2 "$MD_FILE")
    else
        CONTENT=$(cat "$MD_FILE")
    fi
    
    # Integrate stdin content if available
    if [[ -n "$STDIN_CONTENT" ]]; then
        if [[ "$STDIN_POSITION" == "prepend" ]]; then
            CONTENT="The following input was provided via stdin:
---
$STDIN_CONTENT
---

$CONTENT"
        else
            # append
            CONTENT="$CONTENT

---
The following input was provided via stdin:
---
$STDIN_CONTENT"
        fi
    fi
    
    # Build execution command
    if [[ -n "$PROVIDER" ]]; then
        # For provider mode, we need to set up the environment first
        # Load config and secrets like provider scripts do
        load_config
        
        # Set provider-specific environment based on selection
        case $PROVIDER in
            aws)
                export CLAUDE_CODE_USE_BEDROCK=1
                # Parse model args to set ANTHROPIC_MODEL
                parse_model_args "AWS" "${PROVIDER_ARGS[@]}"
                ;;
            vertex)
                export CLAUDE_CODE_USE_VERTEX=1
                parse_model_args "VERTEX" "${PROVIDER_ARGS[@]}"
                ;;
            apikey)
                unset CLAUDE_CODE_USE_BEDROCK
                parse_model_args "ANTHROPIC" "${PROVIDER_ARGS[@]}"
                ;;
            azure)
                export CLAUDE_CODE_USE_FOUNDRY=1
                parse_model_args "AZURE" "${PROVIDER_ARGS[@]}"
                ;;
            vercel)
                if [[ -n "$VERCEL_AI_GATEWAY_URL" ]]; then
                    export ANTHROPIC_BASE_URL="$VERCEL_AI_GATEWAY_URL"
                else
                    export ANTHROPIC_BASE_URL="https://ai-gateway.vercel.sh"
                fi
                if [[ -n "$VERCEL_AI_GATEWAY_TOKEN" ]]; then
                    export ANTHROPIC_AUTH_TOKEN="$VERCEL_AI_GATEWAY_TOKEN"
                fi
                parse_model_args "VERCEL" "${PROVIDER_ARGS[@]}"
                ;;
        esac
        
        # Add --verbose if stream-json output format requires it
        if [[ "$NEEDS_VERBOSE" == true ]]; then
            CLAUDE_ARGS=("--verbose" "${CLAUDE_ARGS[@]}")
        fi
        
        # Execute with print mode
        echo "$CONTENT" | claude -p "${CLAUDE_ARGS[@]}"
    else
        # Add --verbose if stream-json output format requires it
        if [[ "$NEEDS_VERBOSE" == true ]]; then
            CLAUDE_ARGS=("--verbose" "${CLAUDE_ARGS[@]}")
        fi
        
        # Direct to claude without provider setup
        echo "$CONTENT" | claude -p "${CLAUDE_ARGS[@]}"
    fi
    exit $?
fi

#=============================================================================
# MODE 2: PIPED SCRIPT EXECUTION (stdin without file)
# Supports: curl -fsSL https://example.com/install.md | claude-run
#=============================================================================
if [[ -n "$STDIN_CONTENT" ]]; then
    # Check for shebang in piped content and extract flags
    FIRST_LINE="${STDIN_CONTENT%%$'\n'*}"
    
    if [[ "$FIRST_LINE" == "#!"* ]]; then
        # Strip shebang line from content
        CONTENT="${STDIN_CONTENT#*$'\n'}"
        
        # Extract flags from shebang (e.g., "#!/usr/bin/env claude-run --opus --aws")
        # or "#!/usr/bin/env -S claude-run --permission-mode bypassPermissions"
        if [[ "$FIRST_LINE" == *"claude-run"* ]]; then
            SHEBANG_FLAGS="${FIRST_LINE#*claude-run}"
            # Trim leading whitespace
            SHEBANG_FLAGS="${SHEBANG_FLAGS#"${SHEBANG_FLAGS%%[![:space:]]*}"}"
            
            # Parse shebang flags (only if CLI didn't already specify)
            # CLI flags take precedence over shebang flags
            if [[ -n "$SHEBANG_FLAGS" ]]; then
                # Convert shebang flags to array and process
                read -ra SHEBANG_ARR <<< "$SHEBANG_FLAGS"
                for arg in "${SHEBANG_ARR[@]}"; do
                    case "$arg" in
                        # Provider flags - only use if not already set by CLI
                        --aws)     [[ -z "$PROVIDER" ]] && PROVIDER="aws" ;;
                        --vertex)  [[ -z "$PROVIDER" ]] && PROVIDER="vertex" ;;
                        --apikey)  [[ -z "$PROVIDER" ]] && PROVIDER="apikey" ;;
                        --azure)   [[ -z "$PROVIDER" ]] && PROVIDER="azure" ;;
                        --vercel)  [[ -z "$PROVIDER" ]] && PROVIDER="vercel" ;;
                        --pro)     [[ -z "$PROVIDER" ]] && PROVIDER="pro" ;;
                        
                        # Model flags - accumulate (CLI already processed, these extend)
                        --opus|--sonnet|--haiku)
                            PROVIDER_ARGS+=("$arg") ;;
                        
                        # Other flags pass through to claude
                        *)
                            CLAUDE_ARGS+=("$arg") ;;
                    esac
                done
            fi
        fi
    else
        # No shebang, use entire content as prompt
        CONTENT="$STDIN_CONTENT"
    fi
    
    # Build execution command (same logic as file mode)
    if [[ -n "$PROVIDER" ]]; then
        # Load config and secrets for provider mode
        load_config
        
        # Set provider-specific environment based on selection
        case $PROVIDER in
            aws)
                export CLAUDE_CODE_USE_BEDROCK=1
                parse_model_args "AWS" "${PROVIDER_ARGS[@]}"
                ;;
            vertex)
                export CLAUDE_CODE_USE_VERTEX=1
                parse_model_args "VERTEX" "${PROVIDER_ARGS[@]}"
                ;;
            apikey)
                unset CLAUDE_CODE_USE_BEDROCK
                parse_model_args "ANTHROPIC" "${PROVIDER_ARGS[@]}"
                ;;
            azure)
                export CLAUDE_CODE_USE_FOUNDRY=1
                parse_model_args "AZURE" "${PROVIDER_ARGS[@]}"
                ;;
            vercel)
                if [[ -n "$VERCEL_AI_GATEWAY_URL" ]]; then
                    export ANTHROPIC_BASE_URL="$VERCEL_AI_GATEWAY_URL"
                else
                    export ANTHROPIC_BASE_URL="https://ai-gateway.vercel.sh"
                fi
                if [[ -n "$VERCEL_AI_GATEWAY_TOKEN" ]]; then
                    export ANTHROPIC_AUTH_TOKEN="$VERCEL_AI_GATEWAY_TOKEN"
                fi
                parse_model_args "VERCEL" "${PROVIDER_ARGS[@]}"
                ;;
        esac
        
        # Add --verbose if stream-json output format requires it
        if [[ "$NEEDS_VERBOSE" == true ]]; then
            CLAUDE_ARGS=("--verbose" "${CLAUDE_ARGS[@]}")
        fi
        
        # Execute with print mode
        echo "$CONTENT" | claude -p "${CLAUDE_ARGS[@]}"
    else
        # Add --verbose if stream-json output format requires it
        if [[ "$NEEDS_VERBOSE" == true ]]; then
            CLAUDE_ARGS=("--verbose" "${CLAUDE_ARGS[@]}")
        fi
        
        # Direct to claude without provider setup
        echo "$CONTENT" | claude -p "${CLAUDE_ARGS[@]}"
    fi
    exit $?
fi

#=============================================================================
# MODE 3: INTERACTIVE (provider switching or plain claude)
#=============================================================================
if [[ -n "$PROVIDER" ]]; then
    # Delegate to provider script
    exec "$SCRIPT_DIR/claude-$PROVIDER" "${PROVIDER_ARGS[@]}" "${CLAUDE_ARGS[@]}"
else
    # No provider, no file = plain claude
    exec claude "${PROVIDER_ARGS[@]}" "${CLAUDE_ARGS[@]}"
fi
