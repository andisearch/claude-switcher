#!/bin/bash

# Claude Status Script
# Shows current Claude Code configuration for all authentication methods

# Source utils
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
source "$SCRIPT_DIR/claude-switcher-utils.sh"

# Load config to ensure we see what the scripts see
load_config

echo ""
print_status "=== Claude Code Configuration Status ==="
print_status "claude-switcher version: $SWITCHER_VERSION"
echo ""

# Check if we're running in an active Claude session
# This could be:
# 1. Direct child of a wrapper script that has a session file
# 2. Running inside a Claude terminal (child of the claude process)
CURRENT_SESSION_FILE=""
current_pid=$$

# First, walk up the process tree to look for a session file
while [ $current_pid -ne 1 ]; do
    # Check if there's a session file for this PID
    if [ -f "$SESSIONS_DIR/$current_pid" ]; then
        CURRENT_SESSION_FILE="$SESSIONS_DIR/$current_pid"
        break
    fi
    
    # Get parent PID
    current_pid=$(ps -p $current_pid -o ppid= 2>/dev/null | tr -d ' ')
    if [ -z "$current_pid" ]; then
        break
    fi
done

# If we didn't find a session file by walking up, look for Claude processes
# and check if any of them have session files (we might be inside Claude's terminal)
if [ -z "$CURRENT_SESSION_FILE" ]; then
    # Find all claude processes
    for claude_pid in $(pgrep -x "claude" 2>/dev/null); do
        # Check if we're a descendant of this claude process
        check_pid=$$
        while [ $check_pid -ne 1 ]; do
            if [ "$check_pid" = "$claude_pid" ]; then
                # We're a descendant! Check if there's a session file for this claude PID
                # or for any of its ancestors
                session_search_pid=$claude_pid
                while [ $session_search_pid -ne 1 ]; do
                    if [ -f "$SESSIONS_DIR/$session_search_pid" ]; then
                        CURRENT_SESSION_FILE="$SESSIONS_DIR/$session_search_pid"
                        break 2
                    fi
                    session_search_pid=$(ps -p $session_search_pid -o ppid= 2>/dev/null | tr -d ' ')
                    if [ -z "$session_search_pid" ]; then
                        break
                    fi
                done
            fi
            check_pid=$(ps -p $check_pid -o ppid= 2>/dev/null | tr -d ' ')
            if [ -z "$check_pid" ]; then
                break
            fi
        done
        
        # If we found a session, stop searching
        if [ -n "$CURRENT_SESSION_FILE" ]; then
            break
        fi
    done
fi

# If we found a session, display it prominently
if [ -n "$CURRENT_SESSION_FILE" ]; then
    source "$CURRENT_SESSION_FILE"
    
    print_success "ðŸ”µ Running in Active Session"
    print_status "  Provider: $CLAUDE_SESSION_PROVIDER"
    print_status "  Model: $CLAUDE_SESSION_MODEL"
    print_status "  Session ID: $CLAUDE_SESSION_ID"
    
    if [ -n "$CLAUDE_SESSION_REGION" ]; then
        print_status "  Region: $CLAUDE_SESSION_REGION"
    fi
    
    if [ -n "$CLAUDE_SESSION_PROJECT" ]; then
        print_status "  Project: $CLAUDE_SESSION_PROJECT"
    fi
    
    if [ -n "$CLAUDE_SESSION_AUTH_METHOD" ]; then
        print_status "  Auth: $CLAUDE_SESSION_AUTH_METHOD"
    fi
    
    # Calculate uptime
    current_time=$(date +%s)
    elapsed=$((current_time - CLAUDE_SESSION_START_TIME))
    hours=$((elapsed / 3600))
    minutes=$(((elapsed % 3600) / 60))
    seconds=$((elapsed % 60))
    
    if [ $hours -gt 0 ]; then
        uptime_str="${hours}h ${minutes}m ${seconds}s"
    elif [ $minutes -gt 0 ]; then
        uptime_str="${minutes}m ${seconds}s"
    else
        uptime_str="${seconds}s"
    fi
    
    print_status "  Uptime: $uptime_str"
    echo ""
fi

# Check API Key Helper configuration
CLAUDE_SETTINGS_FILE="$HOME/.claude/settings.json"
API_KEY_HELPER_SCRIPT="$HOME/.claude-switcher/claude-api-key-helper.sh"
CURRENT_MODE_FILE="$HOME/.claude-switcher/current-mode.sh"

print_status "API Key Helper Status:"

# Check if settings.json has apiKeyHelper configured
if [ -f "$CLAUDE_SETTINGS_FILE" ]; then
    if grep -q "apiKeyHelper" "$CLAUDE_SETTINGS_FILE" 2>/dev/null; then
        print_success "  settings.json: configured âœ“"
    else
        print_warning "  settings.json: not configured"
        print_warning "  Run setup.sh to configure apiKeyHelper"
    fi
else
    print_warning "  settings.json: not found"
fi

# Check if helper script exists and is executable
if [ -f "$API_KEY_HELPER_SCRIPT" ]; then
    if [ -x "$API_KEY_HELPER_SCRIPT" ]; then
        print_success "  Helper script: exists and executable âœ“"
    else
        print_warning "  Helper script: exists but not executable"
    fi
else
    print_warning "  Helper script: not found at $API_KEY_HELPER_SCRIPT"
fi

# Show current switcher mode
if [ -f "$CURRENT_MODE_FILE" ]; then
    source "$CURRENT_MODE_FILE"
    print_status "  Current switcher mode: ${CLAUDE_SWITCHER_MODE:-not set}"
else
    print_warning "  current-mode.sh: not found"
fi

echo ""

# Detect current authentication mode
mode="Unknown"

# Debug Vercel Check
# echo "DEBUG: URL=$ANTHROPIC_BASE_URL TOKEN=${ANTHROPIC_AUTH_TOKEN:0:5}..."

if [ "$CLAUDE_CODE_USE_BEDROCK" = "1" ] && [ -n "$AWS_BEARER_TOKEN_BEDROCK" ]; then
    mode="AWS Bedrock"
elif [ -n "$ANTHROPIC_BASE_URL" ] && [[ "$ANTHROPIC_BASE_URL" == *"vercel"* ]] && [ -n "$ANTHROPIC_AUTH_TOKEN" ]; then
    mode="Vercel AI Gateway"
elif [ -n "$ANTHROPIC_API_KEY" ] && [ "$CLAUDE_CODE_USE_BEDROCK" != "1" ]; then
    mode="Anthropic API"
elif [ -n "$GOOGLE_CLOUD_PROJECT" ] || [ -n "$GOOGLE_LOCATION" ]; then
    mode="Vertex AI"
elif [ "$CLAUDE_CODE_USE_BEDROCK" = "0" ]; then
    mode="Claude Pro Plan"
else
    mode="Default (likely Claude Pro Plan)"
fi

print_success "Current mode: $mode"
echo ""

# Display relevant environment variables based on mode
case "$mode" in
    "AWS Bedrock")
        print_status "AWS Bedrock Configuration:"
        print_status "  CLAUDE_CODE_USE_BEDROCK: ${CLAUDE_CODE_USE_BEDROCK}"
        print_status "  AWS_REGION: ${AWS_REGION:-not set}"
        print_status "  AWS_BEARER_TOKEN_BEDROCK: ${AWS_BEARER_TOKEN_BEDROCK:+set (hidden)}"
        print_status "  CLAUDE_CODE_MAX_OUTPUT_TOKENS: ${CLAUDE_CODE_MAX_OUTPUT_TOKENS:-not set}"
        print_status "  MAX_THINKING_TOKENS: ${MAX_THINKING_TOKENS:-not set}"
        print_status "  ANTHROPIC_MODEL: ${ANTHROPIC_MODEL:-not set}"
        echo ""
        print_status "Features:"
        print_status "  - API authentication via AWS Bedrock"
        print_status "  - Login/logout disabled"
        print_status "  - Prompt caching available"
        ;;
    
    "Vertex AI")
        print_status "Vertex AI Configuration:"
        print_status "  CLAUDE_CODE_USE_BEDROCK: ${CLAUDE_CODE_USE_BEDROCK:-0}"
        print_status "  GOOGLE_CLOUD_PROJECT: ${GOOGLE_CLOUD_PROJECT:-not set}"
        print_status "  GOOGLE_LOCATION: ${GOOGLE_LOCATION:-not set}"
        print_status "  ANTHROPIC_MODEL: ${ANTHROPIC_MODEL:-not set}"
        echo ""
        # Check if gcloud is configured
        if command -v gcloud &> /dev/null; then
            gcloud_account=$(gcloud config get-value account 2>/dev/null)
            if [ -n "$gcloud_account" ]; then
                print_status "Google Cloud Authentication:"
                print_status "  - Authenticated as: $gcloud_account"
            else
                print_warning "  - Not authenticated with gcloud"
            fi
        else
            print_warning "  - gcloud CLI not found"
        fi
        echo ""
        print_status "Features:"
        print_status "  - API authentication via Google Vertex AI"
        print_status "  - Uses Application Default Credentials"
        print_status "  - Login/logout disabled"
        ;;
    
    "Anthropic API")
        print_status "Anthropic API Configuration:"
        print_status "  CLAUDE_CODE_USE_BEDROCK: ${CLAUDE_CODE_USE_BEDROCK:-0}"
        print_status "  ANTHROPIC_API_KEY: ${ANTHROPIC_API_KEY:+set (hidden)}"
        print_status "  ANTHROPIC_MODEL: ${ANTHROPIC_MODEL:-not set}"
        echo ""
        print_status "Features:"
        print_status "  - API authentication via Anthropic API"
        print_status "  - Login/logout disabled"
        print_status "  - Direct access to Anthropic models"
        ;;

    "Vercel AI Gateway")
        print_status "Vercel AI Gateway Configuration:"
        print_status "  CLAUDE_CODE_USE_BEDROCK: ${CLAUDE_CODE_USE_BEDROCK:-0}"
        print_status "  ANTHROPIC_BASE_URL: ${ANTHROPIC_BASE_URL:-not set}"
        print_status "  ANTHROPIC_AUTH_TOKEN: ${ANTHROPIC_AUTH_TOKEN:+set (hidden)}"
        print_status "  ANTHROPIC_API_KEY: ${ANTHROPIC_API_KEY:-empty (required)}"
        print_status "  ANTHROPIC_MODEL: ${ANTHROPIC_MODEL:-not set}"
        echo ""
        print_status "Features:"
        print_status "  - API authentication via Vercel AI Gateway"
        print_status "  - Automatic failover and unified billing"
        print_status "  - Login/logout disabled"
        ;;
    
    "Claude Pro Plan"|"Default (likely Claude Pro Plan)")
        print_status "Claude Pro Plan Configuration:"
        print_status "  CLAUDE_CODE_USE_BEDROCK: ${CLAUDE_CODE_USE_BEDROCK:-not set}"
        echo ""
        print_status "Features:"
        print_status "  - Web authentication via Claude Pro"
        print_status "  - Login/logout enabled"
        print_status "  - Subject to subscription usage limits"
        ;;
esac

echo ""
print_status "Available commands:"
print_status "  claude-pro          - Switch to Claude Pro Plan mode"
print_status "  claude-aws          - Switch to AWS Bedrock mode"
print_status "  claude-vertex       - Switch to Google Vertex AI mode"
print_status "  claude-apikey    - Switch to Anthropic API mode"
print_status "  claude-vercel       - Switch to Vercel AI Gateway mode"
print_status "  claude-status       - Show current configuration"
print_status "  claude-sessions     - List active Claude sessions"
echo ""
