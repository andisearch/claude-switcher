#!/bin/bash

# AI Status
# Shows current AI Runner configuration and environment status

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
SHARE_DIR="/usr/local/share/ai-runner"

# Set branding
export AI_RUNNER_BRAND="AI Runner"

# Source utils - check dev location first, then installed share directory
if [ -f "$SCRIPT_DIR/lib/core-utils.sh" ]; then
    source "$SCRIPT_DIR/lib/core-utils.sh"
elif [ -f "$SHARE_DIR/lib/core-utils.sh" ]; then
    source "$SHARE_DIR/lib/core-utils.sh"
else
    # Minimal fallback
    BLUE='\033[0;34m'
    GREEN='\033[0;32m'
    YELLOW='\033[1;33m'
    RED='\033[0;31m'
    NC='\033[0m'
    print_status() { echo -e "${BLUE}[AI Runner]${NC} $1"; }
    print_success() { echo -e "${GREEN}[AI Runner]${NC} $1"; }
    print_warning() { echo -e "${YELLOW}[AI Runner]${NC} $1"; }
    print_error() { echo -e "${RED}[AI Runner]${NC} $1"; }
fi

# Set provider/tool dirs for loaders (when installed, these aren't relative to SCRIPT_DIR)
if [ ! -d "$SCRIPT_DIR/../providers" ] && [ -d "$SHARE_DIR/providers" ]; then
    export PROVIDER_DIR="${SHARE_DIR}/providers"
    export TOOL_DIR="${SHARE_DIR}/tools"
fi

# Source loaders if available
if [ -f "$SCRIPT_DIR/lib/provider-loader.sh" ]; then
    source "$SCRIPT_DIR/lib/provider-loader.sh"
elif [ -f "$SHARE_DIR/lib/provider-loader.sh" ]; then
    source "$SHARE_DIR/lib/provider-loader.sh"
fi
if [ -f "$SCRIPT_DIR/lib/tool-loader.sh" ]; then
    source "$SCRIPT_DIR/lib/tool-loader.sh"
elif [ -f "$SHARE_DIR/lib/tool-loader.sh" ]; then
    source "$SHARE_DIR/lib/tool-loader.sh"
fi

# Load config quietly
load_config_quiet 2>/dev/null || true
load_defaults 2>/dev/null || true

echo ""
echo "┌─────────────────────────────────────────────────────────────┐"
echo "│  AI Runner Status                                           │"
echo "└─────────────────────────────────────────────────────────────┘"
echo ""

# Version
echo "Version: ${AI_RUNNER_VERSION:-unknown}"

# Check for updates
_lib_dir="$SCRIPT_DIR/lib"; [ ! -f "$_lib_dir/update-checker.sh" ] && _lib_dir="$SHARE_DIR/lib"
if [ -f "$_lib_dir/update-checker.sh" ]; then
    source "$_lib_dir/update-checker.sh"
    if check_for_update; then
        echo -e "  ${YELLOW}Update available: v${AI_RUNNER_VERSION:-unknown} -> v${_UPDATE_AVAILABLE_VERSION}${NC}"
        echo -e "  ${CYAN}Run 'ai update' to update${NC}"
    fi
fi
echo ""

# Config Directory
echo "Configuration:"
echo "  Directory:  $CONFIG_DIR"
if [ -f "$SECRETS_FILE" ]; then
    echo "  Secrets:    $SECRETS_FILE (found)"
else
    echo "  Secrets:    $SECRETS_FILE (not found)"
fi
if [ -f "$MODELS_FILE" ]; then
    echo "  Models:     $MODELS_FILE (found)"
else
    echo "  Models:     $MODELS_FILE (not found)"
fi
echo ""

# Saved Defaults
echo "Saved Defaults:"
_defaults_desc=$(format_defaults 2>/dev/null)
if [[ -n "$_defaults_desc" ]]; then
    echo "  ai --${_defaults_desc}"
    echo "  Clear with: ai --clear-default"
else
    echo "  (none)"
fi
echo ""

# Tools Detection
echo "Installed Tools:"
if command -v claude &>/dev/null; then
    claude_version=$(claude --version 2>/dev/null | head -1 || echo "unknown")
    echo "  Claude Code: $claude_version"
else
    echo "  Claude Code: not installed"
fi
# Future: Add opencode, aider, etc.
echo ""

# Provider Status
echo "Provider Status:"

# Ollama
if curl -s --connect-timeout 1 http://localhost:11434/api/tags &>/dev/null; then
    echo "  Ollama:      running (localhost:11434)"
else
    echo "  Ollama:      not running"
fi

# LM Studio
if curl -s --connect-timeout 1 http://localhost:1234/v1/models &>/dev/null; then
    echo "  LM Studio:   running (localhost:1234)"
else
    echo "  LM Studio:   not running"
fi

# Claude Pro - cross-platform credential detection
# macOS: Keychain entry "Claude Code-credentials" (both npm and native installer)
# Linux/WSL: ~/.claude/.credentials.json file
_has_claude_credentials=false
if command -v security &>/dev/null && security find-generic-password -s "Claude Code-credentials" &>/dev/null 2>&1; then
    _has_claude_credentials=true
elif [ -f "$HOME/.claude/.credentials.json" ]; then
    _has_claude_credentials=true
fi
if [ "$_has_claude_credentials" = true ]; then
    echo "  Claude Pro:  logged in"
else
    echo "  Claude Pro:  not logged in"
fi

# Anthropic API
if [ -n "$ANTHROPIC_API_KEY" ]; then
    echo "  Anthropic:   API key configured"
else
    echo "  Anthropic:   no API key"
fi

# AWS Bedrock
if [ -n "$AWS_BEARER_TOKEN_BEDROCK" ] || [ -n "$AWS_ACCESS_KEY_ID" ] || [ -n "$AWS_PROFILE" ]; then
    echo "  AWS Bedrock: credentials configured"
else
    echo "  AWS Bedrock: not configured"
fi

# Google Vertex
if [ -n "$ANTHROPIC_VERTEX_PROJECT_ID" ]; then
    echo "  Vertex AI:   project $ANTHROPIC_VERTEX_PROJECT_ID"
else
    echo "  Vertex AI:   not configured"
fi

# Vercel
if [ -n "$VERCEL_AI_GATEWAY_TOKEN" ]; then
    echo "  Vercel:      token configured"
else
    echo "  Vercel:      not configured"
fi

# Azure
if [ -n "$ANTHROPIC_FOUNDRY_RESOURCE" ] || [ -n "$ANTHROPIC_FOUNDRY_BASE_URL" ]; then
    echo "  Azure:       configured"
else
    echo "  Azure:       not configured"
fi

echo ""

# Current Environment (if any AI-related vars are set)
if [ -n "$ANTHROPIC_MODEL" ] || [ -n "$CLAUDE_CODE_USE_BEDROCK" ] || [ -n "$CLAUDE_CODE_USE_VERTEX" ]; then
    echo "Current Environment:"
    [ -n "$ANTHROPIC_MODEL" ] && echo "  ANTHROPIC_MODEL: $ANTHROPIC_MODEL"
    [ -n "$ANTHROPIC_SMALL_FAST_MODEL" ] && echo "  ANTHROPIC_SMALL_FAST_MODEL: $ANTHROPIC_SMALL_FAST_MODEL"
    [ "$CLAUDE_CODE_USE_BEDROCK" = "1" ] && echo "  CLAUDE_CODE_USE_BEDROCK: enabled"
    [ "$CLAUDE_CODE_USE_VERTEX" = "1" ] && echo "  CLAUDE_CODE_USE_VERTEX: enabled"
    [ "$CLAUDE_CODE_USE_FOUNDRY" = "1" ] && echo "  CLAUDE_CODE_USE_FOUNDRY: enabled"
    [ -n "$ANTHROPIC_BASE_URL" ] && echo "  ANTHROPIC_BASE_URL: $ANTHROPIC_BASE_URL"
    echo ""
fi

# Active Sessions Summary
if [ -d "$SESSIONS_DIR" ]; then
    session_count=$(ls -1 "$SESSIONS_DIR" 2>/dev/null | wc -l | tr -d ' ')
    if [ "$session_count" -gt 0 ]; then
        echo "Active Sessions: $session_count"
        echo "  Run 'ai-sessions' for details"
        echo ""
    fi
fi

# Quick Start
echo "Quick Start:"
echo "  ai task.md              # Execute with auto-detected provider"
echo "  ai --ollama task.md     # Execute with local Ollama (free)"
echo "  ai --aws --opus         # Interactive with AWS Bedrock + Opus"
echo ""
