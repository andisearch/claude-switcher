#!/bin/bash

# Source utils
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
source "$SCRIPT_DIR/utils.sh"

# Load config and secrets
load_config

# Generate unique session identifier
CLAUDE_SESSION_ID="vertex-$$-$(date +%s)"
export CLAUDE_SESSION_ID

print_status "Switching to Claude Google Vertex AI mode..."
print_status "Session ID: $CLAUDE_SESSION_ID"

# Store existing environment variables
SAVED_ANTHROPIC_MODEL="$ANTHROPIC_MODEL"
SAVED_CLAUDE_CODE_USE_BEDROCK="$CLAUDE_CODE_USE_BEDROCK"
# Note: Vertex might use other vars, but we primarily need to ensure Bedrock is OFF
# and standard Google auth is ON.

# Disable Bedrock
export CLAUDE_CODE_USE_BEDROCK=0
unset AWS_BEARER_TOKEN_BEDROCK

# Parse arguments to select model
parse_model_args "VERTEX" "$@"

# Strip our custom flags
ARGS=()
while [[ $# -gt 0 ]]; do
    case $1 in
        --opus|--sonnet)
            shift
            ;;
        --model)
            shift 2
            ;;
        *)
            ARGS+=("$1")
            shift
            ;;
    esac
done

print_success "Claude Vertex AI mode activated"
print_status "- Using Google Vertex AI"
print_status "- Project: $GOOGLE_CLOUD_PROJECT"
print_status "- Location: $GOOGLE_LOCATION"
print_status "- Model: $ANTHROPIC_MODEL"

print_status "Launching Claude Code..."

restore_environment() {
    print_status "Restoring original environment variables..."
    
    if [ -n "$SAVED_ANTHROPIC_MODEL" ]; then
        export ANTHROPIC_MODEL="$SAVED_ANTHROPIC_MODEL"
    else
        unset ANTHROPIC_MODEL
    fi
    
    if [ -n "$SAVED_CLAUDE_CODE_USE_BEDROCK" ]; then
        export CLAUDE_CODE_USE_BEDROCK="$SAVED_CLAUDE_CODE_USE_BEDROCK"
    else
        unset CLAUDE_CODE_USE_BEDROCK
    fi
    
    print_success "Environment restored"
}

trap restore_environment EXIT

# Launch Claude Code
claude "${ARGS[@]}"
