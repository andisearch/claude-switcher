#!/bin/bash

# Claude Anthropic API Mode (Legacy command - use 'ai --apikey' instead)
#
# This uses pure environment variables for session-isolated authentication.
# If you're also logged into Claude Pro, you'll see an "Auth conflict" warning -
# this is informational only, Claude will use the API key for billing.

# Source utils
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
source "$SCRIPT_DIR/claude-switcher-utils.sh"

# Display banner
display_banner

# Handle --version flag
if [[ "$1" == "--version" ]] || [[ "$1" == "-v" ]]; then
    echo "claude-switcher v$SWITCHER_VERSION"
    exit 0
fi

# Load config and secrets
load_config

# Generate unique session identifier
CLAUDE_SESSION_ID="anthropic-$$-$(date +%s)"
export CLAUDE_SESSION_ID

print_status "Switching to Claude Anthropic API mode..."
print_status "Session ID: $CLAUDE_SESSION_ID"

# Store existing environment variables for restoration
SAVED_ANTHROPIC_MODEL="$ANTHROPIC_MODEL"
SAVED_ANTHROPIC_SMALL_FAST_MODEL="$ANTHROPIC_SMALL_FAST_MODEL"
SAVED_CLAUDE_CODE_USE_BEDROCK="$CLAUDE_CODE_USE_BEDROCK"

# Disable Bedrock
unset CLAUDE_CODE_USE_BEDROCK
unset AWS_BEARER_TOKEN_BEDROCK

# Ensure API Key is present (loaded by load_config from secrets.sh)
if [ -z "$ANTHROPIC_API_KEY" ]; then
    print_error "ANTHROPIC_API_KEY is not set"
    print_error ""
    print_error "To use Anthropic API mode, you need to:"
    print_error "  1. Set ANTHROPIC_API_KEY in your secrets.sh file"
    print_error "  2. Get an API key from: https://console.anthropic.com/"
    print_error ""
    print_error "Example secrets.sh:"
    print_error "  export ANTHROPIC_API_KEY=\"sk-ant-...\""
    exit 1
fi

# Parse arguments to select model
parse_model_args "ANTHROPIC" "$@"

# Strip our custom flags
ARGS=()
while [[ $# -gt 0 ]]; do
    case $1 in
        --opus|--sonnet|--haiku)
            shift
            ;;
        --model)
            shift 2
            ;;
        *)
            ARGS+=("$1")
            shift
            ;;
    esac
done

print_success "Claude Anthropic API mode activated"
print_status "- Using Anthropic API"
print_status "- Model: $ANTHROPIC_MODEL"
print_status "- Small/Fast Model: $ANTHROPIC_SMALL_FAST_MODEL"
print_status "- Auth: API Key (session-isolated via environment)"

echo ""
print_warning "Note: If you see an 'Auth conflict' warning below, this is expected."
print_status "Your API key will be used for billing. The warning is informational only."
print_status "To permanently switch to API-only mode, run: claude /logout"
echo ""

print_status "Launching Claude Code..."

# Write session information for tracking
write_session_info \
    "Anthropic API" \
    "BYOK" \
    "$ANTHROPIC_MODEL" \
    "$ANTHROPIC_SMALL_FAST_MODEL" \
    "" \
    "" \
    "API Key"

# KEEP ANTHROPIC_API_KEY set - Claude Code uses it directly
# If user is also logged into Pro, they'll see "Auth conflict" warning (informational only)

restore_environment() {
    print_status "Restoring original environment variables..."

    # Clean up session tracking file
    cleanup_session_info

    # Restore environment variables
    if [ -n "$SAVED_ANTHROPIC_MODEL" ]; then
        export ANTHROPIC_MODEL="$SAVED_ANTHROPIC_MODEL"
    else
        unset ANTHROPIC_MODEL
    fi

    if [ -n "$SAVED_ANTHROPIC_SMALL_FAST_MODEL" ]; then
        export ANTHROPIC_SMALL_FAST_MODEL="$SAVED_ANTHROPIC_SMALL_FAST_MODEL"
    else
        unset ANTHROPIC_SMALL_FAST_MODEL
    fi

    if [ -n "$SAVED_CLAUDE_CODE_USE_BEDROCK" ]; then
        export CLAUDE_CODE_USE_BEDROCK="$SAVED_CLAUDE_CODE_USE_BEDROCK"
    else
        unset CLAUDE_CODE_USE_BEDROCK
    fi

    print_success "Environment restored"
}

trap restore_environment EXIT

# Launch Claude Code
claude "${ARGS[@]}"
