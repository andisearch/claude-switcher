#!/bin/bash

# Claude Pro Plan Mode (Legacy command - use 'ai --pro' instead)
#
# This uses pure environment variables for session-isolated authentication.
# Uses native Claude Code subscription auth (no API key needed).

# Source utils
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
source "$SCRIPT_DIR/claude-switcher-utils.sh"

# Display banner
display_banner

# Handle --version flag
if [[ "$1" == "--version" ]] || [[ "$1" == "-v" ]]; then
    echo "claude-switcher v$SWITCHER_VERSION"
    exit 0
fi

# Load config (mainly for consistency, though Pro doesn't need keys)
load_config

CLAUDE_SESSION_ID="pro-$$-$(date +%s)"
export CLAUDE_SESSION_ID

print_status "Switching to Claude Pro Plan mode..."
print_status "Session ID: $CLAUDE_SESSION_ID"

# Store existing environment variables for restoration
SAVED_CLAUDE_CODE_USE_BEDROCK="$CLAUDE_CODE_USE_BEDROCK"
SAVED_ANTHROPIC_API_KEY="$ANTHROPIC_API_KEY"
SAVED_AWS_BEARER_TOKEN_BEDROCK="$AWS_BEARER_TOKEN_BEDROCK"

# Disable BYOK providers
unset CLAUDE_CODE_USE_BEDROCK
unset CLAUDE_CODE_USE_VERTEX
unset CLAUDE_CODE_USE_FOUNDRY

# Unset API keys to use subscription auth
unset ANTHROPIC_API_KEY
unset ANTHROPIC_BASE_URL
unset ANTHROPIC_AUTH_TOKEN
unset AWS_BEARER_TOKEN_BEDROCK

print_success "Claude Pro Plan mode activated"
print_status "- Using Web Authentication"
print_status "- Auth: Claude Pro Subscription (session-isolated)"

print_status "Launching Claude Code..."

# Write session information for tracking
write_session_info \
    "Claude Pro" \
    "Subscription" \
    "Default" \
    "Default" \
    "" \
    "" \
    "Web Authentication"

restore_environment() {
    print_status "Restoring original environment variables..."

    # Clean up session tracking file
    cleanup_session_info

    if [ -n "$SAVED_CLAUDE_CODE_USE_BEDROCK" ]; then
        export CLAUDE_CODE_USE_BEDROCK="$SAVED_CLAUDE_CODE_USE_BEDROCK"
    else
        unset CLAUDE_CODE_USE_BEDROCK
    fi

    if [ -n "$SAVED_ANTHROPIC_API_KEY" ]; then
        export ANTHROPIC_API_KEY="$SAVED_ANTHROPIC_API_KEY"
    else
        unset ANTHROPIC_API_KEY
    fi

    if [ -n "$SAVED_AWS_BEARER_TOKEN_BEDROCK" ]; then
        export AWS_BEARER_TOKEN_BEDROCK="$SAVED_AWS_BEARER_TOKEN_BEDROCK"
    else
        unset AWS_BEARER_TOKEN_BEDROCK
    fi

    print_success "Environment restored"
}

trap restore_environment EXIT

# Launch Claude Code
claude "$@"
